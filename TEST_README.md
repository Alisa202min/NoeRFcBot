# مجموعه تست‌های RFCBot

این مجموعه شامل تست‌های خودکار برای بات تلگرام RFCBot است. تمرکز اصلی این تست‌ها بر روی اطمینان از صحت نمایش ساختار سلسله مراتبی دسته‌بندی‌ها در بات و مطابقت آن با ساختار پایگاه داده است.

## مشخصات

- **زبان برنامه‌نویسی**: Python
- **فریم‌ورک تست**: pytest
- **فریم‌ورک بات**: aiogram 3.7.0+
- **پایگاه داده**: PostgreSQL
- **تست استرس**: Locust

## ویژگی‌های تست شده

1. **دستورات بات**:
   - `/start`: پیام خوشامدگویی و نمایش کیبورد اصلی
   - `/products`: نمایش دسته‌بندی‌های محصولات
   - `/services`: نمایش دسته‌بندی‌های خدمات
   - `/contact`: اطلاعات تماس
   - `/about`: درباره ما
   - و سایر دستورات...

2. **جریان‌های مکالمه**:
   - مرور دسته‌بندی‌ها (محصولات، خدمات، محتوای آموزشی)
   - انتخاب دسته‌بندی و مشاهده زیردسته‌ها
   - انتخاب محصول/خدمت و مشاهده جزئیات
   - ارسال استعلام قیمت
   - حرکت رو به عقب در ساختار سلسله مراتبی

3. **ساختار سلسله مراتبی دسته‌بندی‌ها**:
   - بررسی نمایش صحیح سلسله مراتب 4 سطحی دسته‌بندی‌ها
   - تأیید مطابقت ساختار درختی نمایش داده شده با ساختار پایگاه داده
   - بررسی عدم وجود فرزند برای گره‌های سطح 4 (گره‌های برگ)

4. **تعامل با پایگاه داده**:
   - افزودن، بروزرسانی و حذف دسته‌بندی‌ها
   - عملیات CRUD روی محصولات، خدمات و محتوای آموزشی
   - بررسی cascade حذف دسته‌بندی‌ها

5. **پنل مدیریت**:
   - تست عملیات CRUD در رابط کاربری پنل مدیریت
   - بررسی انعکاس فوری تغییرات پنل مدیریت در بات
   - مدیریت چهار سطح دسته‌بندی‌ها

6. **تست استرس**:
   - شبیه‌سازی کاربران متعدد با استفاده از Locust
   - تست عملکرد کلی سیستم تحت بار

## ساختار فایل‌ها

```
/
├── tests/
│   ├── conftest.py          # فیکسچرهای مشترک
│   ├── test_bot.py          # تست‌های دستورات بات
│   ├── test_flows.py        # تست‌های جریان مکالمه و ساختار سلسله مراتبی
│   ├── test_db.py           # تست‌های تعامل با پایگاه داده
│   ├── test_admin.py        # تست‌های پنل مدیریت
│   └── README.md            # مستندات تست‌ها
├── locustfile.py            # تست استرس با Locust
├── run_tests.py             # اسکریپت اجرای همه تست‌ها
└── TEST_README.md           # این فایل
```

## نحوه اجرا

### پیش‌نیازها

1. نصب وابستگی‌ها:
   ```bash
   pip install pytest pytest-asyncio pytest-flask locust
   ```

2. تنظیم متغیرهای محیطی:
   ```bash
   export DATABASE_URL=postgresql://username:password@localhost:5432/rfcbot_test
   export TEST_BOT_TOKEN=your_test_bot_token
   ```

### اجرای تست‌ها

1. **اجرای تمام تست‌ها**:
   ```bash
   python run_tests.py
   ```

2. **اجرای تست‌های خاص**:
   ```bash
   pytest -v tests/test_bot.py
   pytest -v tests/test_flows.py
   pytest -v tests/test_db.py
   pytest -v tests/test_admin.py
   ```

3. **اجرای تست استرس**:
   ```bash
   locust -f locustfile.py --host=http://localhost:5000
   ```

## نکات مهم

1. **پایگاه داده تست**:
   - تست‌ها از یک پایگاه داده جداگانه استفاده می‌کنند تا روی داده‌های واقعی تأثیر نگذارند.
   - اسکیما و داده‌های تست به طور خودکار در `conftest.py` ایجاد می‌شوند.

2. **شبیه‌سازی API تلگرام**:
   - تست‌ها API تلگرام را شبیه‌سازی می‌کنند تا از ارسال درخواست‌های واقعی جلوگیری شود.
   - از `AsyncMock` برای شبیه‌سازی پاسخ‌های تلگرام استفاده می‌شود.

3. **محیط CI/CD**:
   - تست‌ها می‌توانند در محیط CI/CD اجرا شوند.
   - برای GitHub Actions، می‌توانید از سرویس PostgreSQL در workflow استفاده کنید.

4. **تست در محیط توسعه**:
   - برای دیباگ آسان‌تر، تست‌ها را در محیط توسعه با verbose mode اجرا کنید:
     ```bash
     pytest -vv tests/test_bot.py
     ```

## هدف تست‌ها

هدف اصلی این تست‌ها، اطمینان از این است که ساختار سلسله مراتبی دسته‌بندی‌ها که توسط بات نمایش داده می‌شود، دقیقاً با ساختار چهار سطحی ذخیره شده در پایگاه داده مطابقت دارد. این به‌معنای این است که اگر کاربر در پنل مدیریت دسته‌بندی‌ها را اضافه، ویرایش یا حذف کند، این تغییرات باید بلافاصله در پاسخ‌های بات نیز منعکس شود.

همچنین، این تست‌ها تأیید می‌کنند که گره‌های سطح 4 (آخرین سطح)، گره‌های برگ هستند و فرزندی ندارند، و محصولات/خدمات فقط به گره‌های برگ پیوند داده می‌شوند.