# تست‌های خودکار RFCBot

این مجموعه تست‌های خودکار برای اطمینان از عملکرد صحیح بات تلگرام RFCBot طراحی شده است، با تمرکز ویژه بر روی ساختار سلسله مراتبی دسته‌بندی‌ها.

## ویژگی‌های تست شده

- تست دستورات بات (`/start`, `/products`, `/services`, `/education`, و غیره)
- تست جریان‌های مکالمه (انتخاب دسته‌بندی‌ها، مشاهده محصولات، ارسال استعلام)
- تست ساختار سلسله مراتبی دسته‌بندی‌ها (بررسی مطابقت با ساختار پایگاه داده)
- تست عملیات پنل مدیریت و اطمینان از انعکاس تغییرات در بات
- تست‌های استرس با استفاده از Locust

## پیش‌نیازها

1. Python 3.8 یا بالاتر
2. PostgreSQL
3. بسته‌های Python مورد نیاز (در requirements.txt)

## نصب

```bash
# نصب وابستگی‌ها
pip install -r requirements.txt

# نصب locust برای تست استرس (اختیاری)
pip install locust
```

## تنظیم محیط تست

1. یک دیتابیس تست ایجاد کنید:
   ```sql
   CREATE DATABASE rfcbot_test;
   ```

2. متغیرهای محیطی را تنظیم کنید:
   ```bash
   export PGUSER=postgres
   export PGPASSWORD=postgres
   export PGHOST=localhost
   export PGPORT=5432
   export DATABASE_URL=postgresql://postgres:postgres@localhost:5432/rfcbot_test
   export TEST_BOT_TOKEN=your_test_bot_token
   ```

## اجرای تست‌ها

### اجرای تمام تست‌ها

```bash
pytest -v
```

### اجرای تست‌های خاص

```bash
# تست‌های بات
pytest -v tests/test_bot.py

# تست‌های جریان‌های مکالمه و ساختار سلسله مراتبی دسته‌بندی‌ها
pytest -v tests/test_flows.py

# تست‌های پایگاه داده
pytest -v tests/test_db.py

# تست‌های پنل مدیریت
pytest -v tests/test_admin.py
```

### اجرای تست استرس با Locust

```bash
locust -f locustfile.py --host=http://localhost:5000
```

سپس در مرورگر به آدرس `http://localhost:8089` بروید تا رابط کاربری Locust را ببینید.

## ساختار تست‌ها

- `tests/conftest.py`: فیکسچرهای مشترک برای تمام تست‌ها
- `tests/test_bot.py`: تست دستورات و پاسخ‌های بات
- `tests/test_flows.py`: تست جریان‌های مکالمه و ساختار سلسله مراتبی دسته‌بندی‌ها
- `tests/test_db.py`: تست تعامل با پایگاه داده
- `tests/test_admin.py`: تست عملکرد پنل مدیریت
- `locustfile.py`: تست استرس برای بررسی عملکرد تحت بار

## نکات مهم

- تست‌ها از یک پایگاه داده جداگانه استفاده می‌کنند تا بر روی داده‌های واقعی تأثیر نگذارند.
- API تلگرام در تست‌ها شبیه‌سازی شده است تا از ارسال درخواست‌های واقعی جلوگیری شود.
- تست‌ها تأیید می‌کنند که سلسله مراتب دسته‌بندی‌ها در بات دقیقاً با ساختار پایگاه داده مطابقت دارد.
- ساختار سلسله مراتبی چهار سطحی دسته‌بندی‌ها (سطح 1 تا 4) به طور کامل تست می‌شود.
- تست‌ها تأیید می‌کنند که تغییرات انجام شده در پنل مدیریت بلافاصله در بات قابل مشاهده هستند.

## افزودن تست‌های جدید

برای افزودن تست‌های جدید، یک فایل تست جدید در پوشه `tests/` ایجاد کنید و از قراردادهای استاندارد pytest پیروی کنید. از فیکسچرهای موجود در `conftest.py` برای دسترسی به بات، دیتابیس، و کلاینت وب استفاده کنید.